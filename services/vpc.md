# VPC

## VPC

Amazon Virtual Private Cloudの略で、AWSにて仮想ネットワーク環境を構築する仕組みのこと。

仮想ネットワーク環境とは簡単に言うと、あるプライベートIPのアドレス範囲で環境を区切り、
区切られた内外のアクセスをコントロールする仕組みを指す。

※プライベートIPは[RFC 1918](https://tools.ietf.org/html/rfc1918)で定義された
`10.0.0.0 - 10.255.255.255`、`172.16.0.0 - 172.31.255.255`、`192.168.0.0 - 192.168.255.255`
のIP範囲。このIPを見ると少しピンと来る人もいるかもしれないので記載。

### VPCの使いどころ

`EC2`、`ELB`、`ElastiCache`、`RDS`のサービスで作成されるリソースはVPC内のIPで作成される。

これらのサービスを利用する場合VPCが必須。逆に利用しない場合不要。

### VPCの料金

VPCを作成するだけならタダ。

ただし、VPCを必要とするサービスのリソースは立てているだけでお金がかかるし、高め。

## サブネット/ルートテーブル

サブネットとルートテーブルは慣例的に合わせて使う。

`サブネット`とはVPCをIP範囲及び[アベイラビリティゾーン](/tldr/region-az.md)で仕切る仕組みのこと。

`ルートテーブル`とはサブネットにおける、ネットワークの経路を決定するためのルールセットのこと。

これらを組み合わせて使うことにより、VPC内外とのアクセスを制限したりコントロールしたり出来る。

`EC2`、`ELB`、`ElastiCache`、`RDS`などのVPC内のリソースはサブネットと紐付けることにより、アクセスのコントロールを行う。

### ルートテーブルのルーティング/インターネットゲートウェイ

ルートテーブルは`Destination`と`Target`の組み合わせでネットワークの経路を決定する。

`Destination`は通信先のIPアドレス範囲、`Target`は通信が通過する`ゲートウェイ`を指定する。

一般的にインターネットと通信するサブネットを作るために、ルートテーブルの`Target`に`インターネットゲートウェイ` (igw-xxx) を指定したルートテーブルを作成する。

**インターネットと通信するルートテーブルの例**

`10.0.0.0/16`のアドレス範囲に対する通信をVPC内部に割り振り、それ以外の全ての通信`0.0.0.0/0`をインターネットに割り振るルートテーブル。

`local`はVPC内部の通信を指し、ルートテーブルを作ると自動的に作成される。

| 送信先      | ターゲット |
|:------------|:-----------|
| 10.0.0.0/16 | local      |
| 0.0.0.0/0   | igw-xxx    |

ルートテーブルの`Target`となるゲートウェイはインターネットゲートウェイの他にも`NATゲートウェイ`、`仮想プライベートゲートウェイ`などがある (応用編なので割愛する) 。

※`/16`のような表記を[サブネットマスク](https://ja.wikipedia.org/wiki/%E3%82%B5%E3%83%96%E3%83%8D%E3%83%83%E3%83%88%E3%83%9E%E3%82%B9%E3%82%AF)という。IPアドレス範囲を識別するための数値。

### サブネット作成のよくある例

- VPCのIP範囲を`10.0.0.0/16`とする
- インターネットと通信するリソースを配置するサブネットをpublicと命名する
  - EC2、ELBなどを配置することを想定
- インターネットと通信しないリソースを配置するサブネットをprivateと命名する
  - RDS、ElastiCacheなどを配置することを想定
- リージョンを`ap-northeast-1`とし、サブネットを複数のアベイラビリティゾーンに配置し冗長化する

| 論理名     | IP範囲                              | アベイラビリティゾーン | ルートテーブル             | 配置するリソース |
|:-----------|:------------------------------------|:-----------------------|:---------------------------|:-----------------|
| public-1a  | 10.0.1.0/24 (10.0.1.0 - 10.0.1.255) | ap-northeast-1a        | インターネットと通信する   | ELB, EC2         |
| public-1c  | 10.0.2.0/24 (10.0.2.0 - 10.0.2.255) | ap-northeast-1c        | インターネットと通信する   | ELB, EC2         |
| private-1a | 10.0.3.0/24 (10.0.3.0 - 10.0.3.255) | ap-northeast-1a        | インターネットと通信しない | RDS, ElastiCache |
| private-1c | 10.0.4.0/24 (10.0.4.0 - 10.0.4.255) | ap-northeast-1c        | インターネットと通信しない | RDS, ElastiCache |

_TODO: 絵を描く_

## セキュリティグループ

セキュリティグループはVPC内のサービスで利用できるファイアウォールの仕組みである。

セキュリティグループは、`EC2`、`ELB`などのリソースに対して紐付けて使う。
そのためサブネットによるアクセスコントロールよりも細かいアクセス制御が可能になる。

慣例的に社内限定アクセスや特定のプロトコル/ポートでのアクセスのみに制限する時に利用する。

**インバウンドの例**

インバウンドには`どこかの送信元→セキュリティグループがアタッチされたリソース`のアクセスルールを記載する。

| 送信元                              | プロトコル | ポート | 説明                                                                                                                                               |
|:------------------------------------|:-----------|:-------|:---------------------------------------------------------------------------------------------------------------------------------------------------|
| 0.0.0.0/0                           | TCP        | 80     | どこからでもHTTPによるアクセスを許可する。EC2をウェブサーバーとして使う場合など。                                                                  |
| x.x.x.x./32 (例えば社内のIPなど)    | TCP        | 22     | x.x.x.xのIPアドレスからのsshアクセスを許可する。社内限定でssh出来る開発サーバーなど。                                                              |
| sg-xxx (とあるセキュリティグループ) | TCP        | 22     | sg-xxxというセキュリティグループからのsshアクセスを許可する。踏み台サーバーなどにsg-xxxを割り当て、踏み台サーバーからのsshのみを許可する場合など。 |

**アウトバウンドの例**

アウトバウンドには`セキュリティグループがアタッチされたリソース→どこかの送信先`のアクセスルールを記載する。

慣例的にインターネットアクセスへのアクセス制御はサブネットで行うことが多いため、アウトバウンドセキュリティグループにはすべてのアウトバウンドを許可にしておくことが多い。

| 送信先                              | プロトコル | ポート | 説明                                                       |
|:------------------------------------|:-----------|:-------|:-----------------------------------------------------------|
| 0.0.0.0/0                           | すべて     | すべて | いずれの場所へのすべてのアウトバウンドアクセスを許可する。 |

_TODO: よくあるセキュリティグループのデザインパターン_
